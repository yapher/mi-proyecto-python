{% extends 'layout.html' %}
{% block content %}
<style>
    html, body {
        height: 100%;
        margin: 0;
        padding: 0;
        background-color: #3e2d59;
    }
    .full-height {
        min-height: 100vh;
        display: flex;
        flex-direction: column;
    }
    .grafico-container {
        width: 40%;
        max-width: 100%;
        height: auto;
    }
    #graficoTorta {
        width: 100% !important;
        height: auto !important;
    }
    .table-responsive {
        flex: 1;
        overflow-y: auto;
    }
</style>

<div class="container-fluid full-height py-3">
    <h1 class="text-center" style="color: #1f9336;">Ã“rdenes de Mantenimiento</h1>
    <h2 id="contador-filas" class="text-white text-center mb-4">
        Cantidad total de ordenes: {{ num_filas }}
    </h2>

    <!-- Selector de archivo -->
    <div class="mb-3">
        <label class="text-white">Seleccionar fecha de archivo:</label>
        <select id="archivoSelector" class="form-select" onchange="cambiarArchivo()">
            {% for archivo, fecha in selector %}
            <option value="{{ archivo }}" {% if archivo==archivo_actual %}selected{% endif %}>
                {{ fecha }}
            </option>
            {% endfor %}
        </select>
    </div>

    <!-- GrÃ¡fico -->
    <div class="grafico-container mb-4">
        <canvas id="graficoTorta"></canvas>
    </div>

    <!-- Selector de columna y bÃºsqueda -->
    <div class="mb-3 row g-2">
        <div class="col-md-6">
            <select id="columnaSelector" class="form-select" onchange="generarGrafico()">
                <option value="">Seleccionar columna a graficar</option>
            </select>
        </div>
        <div class="col-md-6">
            <input type="text" id="busqueda" class="form-control" onkeyup="buscar()"
                placeholder="Buscar en la tabla..." />
        </div>
    </div>

    <!-- Tabla -->
    <div class="table-responsive tabla-scroll sticky-header">
        {# ðŸ”¹ Reemplazar valores vacÃ­os por "sin valor" #}
        {% set safe_tables = tables | replace('><td></td><', '><td>sin valor</td><') %}
        {{ safe_tables | safe }}
    </div>
</div>

<!-- Contenedor para cargar modales -->
<div id="modalContainer"></div>

<script>
    function cambiarArchivo() {
        const archivo = document.getElementById("archivoSelector").value;
        window.location.href = `/listar_ot?archivo=${archivo}`;
    }

    function buscar() {
        const input = document.getElementById("busqueda").value.toLowerCase();
        const filas = document.querySelectorAll("tbody tr");
        let contador = 0;
        filas.forEach(fila => {
            const texto = fila.innerText.toLowerCase();
            const coincide = texto.includes(input);
            fila.style.display = coincide ? "" : "none";
            if (coincide) contador++;
        });
        document.getElementById("contador-filas").textContent = `Cantidad total de filas: ${contador}`;
    }

    let grafico = null;
    function generarGrafico() {
        const tabla = document.querySelector("table");
        if (!tabla) return;
        const indexSeleccionado = document.getElementById("columnaSelector").value;
        if (indexSeleccionado === "") return;

        const filas = tabla.querySelectorAll("tbody tr");
        const conteo = {};
        filas.forEach(fila => {
            let valor = fila.querySelectorAll("td")[indexSeleccionado].innerText.trim();
            const encabezado = document.querySelectorAll("thead th")[indexSeleccionado].innerText.trim().toLowerCase();
            if (encabezado === "numero_orden") {
                valor = valor.substring(0, 4);
            }
            conteo[valor] = (conteo[valor] || 0) + 1;
        });

        const labels = Object.keys(conteo);
        const data = Object.values(conteo);
        const ctx = document.getElementById("graficoTorta").getContext("2d");

        if (grafico) grafico.destroy();
        grafico = new Chart(ctx, {
            type: 'pie',
            data: {
                labels,
                datasets: [{
                    data,
                    backgroundColor: ['#4caf50', '#f44336', '#2196f3', '#ff9800', '#9c27b0', '#00bcd4', '#795548', '#607d8b', '#ffc107']
                }]
            },
            options: {
                responsive: true,
                maintainAspectRatio: false,
                plugins: {
                    legend: { position: 'right', labels: { color: '#fff' } },
                    datalabels: {
                        color: '#fff',
                        formatter: (value, ctx) =>
                            (value / ctx.dataset.data.reduce((a, b) => a + b) * 100).toFixed(1) + '%',
                        font: { weight: 'bold', size: 14 }
                    }
                },
                onClick: (evt, elements) => {
                    if (elements.length > 0) {
                        const index = elements[0].index;
                        const grupo = labels[index];
                        abrirModal(grupo);
                    }
                }
            },
            plugins: [ChartDataLabels]
        });
    }

    // ðŸ”¹ Abrir modal cargado desde filtroTorta.html
    function abrirModal(grupo) {
        const indexSeleccionado = document.getElementById("columnaSelector").value;
        const encabezado = document.querySelectorAll("thead th")[indexSeleccionado].innerText.trim();
        const archivo = document.getElementById("archivoSelector").value;

        fetch(`/filtro_torta/${encodeURIComponent(encabezado)}/${encodeURIComponent(grupo)}?archivo=${archivo}`)
            .then(res => res.text())
            .then(html => {
                document.getElementById("modalContainer").innerHTML = html;
                const modal = new bootstrap.Modal(document.getElementById("filtroTortaModal"));
                modal.show();
            });
    }

    document.addEventListener("DOMContentLoaded", () => {
        const encabezados = document.querySelectorAll("thead th");
        const selector = document.getElementById("columnaSelector");
        encabezados.forEach((th, i) => {
            const opt = document.createElement("option");
            opt.value = i;
            opt.textContent = th.innerText.trim();
            selector.appendChild(opt);
        });
        const opcionEstado = Array.from(selector.options).find(opt => opt.textContent.toLowerCase() === "estado");
        if (opcionEstado) {
            selector.value = opcionEstado.value;
            generarGrafico();
        }
    });
</script>
{% endblock %}

{% extends 'layout.html' %}

{% block content %}
<h3 class="mb-3">Crear Procedimiento</h3>

<div class="bg-form mb-4">
    <form id="formulario">
        <!-- Selectores multinivel -->
        <div id="nivelesContainer" class="mb-3"></div>

        <!-- Nombre, emoji y ruta -->
        <div class="mb-3 input-with-emoji">
            <span class="input-emoji">ðŸ“›</span>
            <textarea rows="4" cols="50" class="form-control ps-5" id="nombre" placeholder="Nombre del Ã­tem"></textarea>
        </div>
        <div class="mb-3 input-with-emoji">
            <span class="input-emoji">ðŸ˜€</span>
            <input type="text" class="form-control ps-5" id="emoji" placeholder="Emoji">
        </div>
        <div class="mb-3 input-with-emoji">
            <span class="input-emoji">ðŸ”—</span>
            <input type="text" class="form-control ps-5" id="ruta_menu" placeholder="Ruta (opcional)">
        </div>
        <input type="hidden" id="ruta_original">
        <div class="button-group">
            <button type="button" class="btn btn-agregar" onclick="guardar()">Agregar</button>
            <button type="button" class="btn btn-editar" onclick="editar()" style="display:none;">Guardar cambios</button>
            <button type="button" class="btn btn-cancelar" onclick="cancelar()" style="display:none;">Cancelar</button>
        </div>
    </form>
</div>

<div class="table-responsive tabla-scroll">
    <table class="table table-hover table-striped table-dark align-middle w-100 mb-0">
        <thead class="sticky-header">
            <tr>
                <th>Emoji</th>
                <th>Nombre</th>
                <th>Ruta</th>
                <th>Acciones</th>
            </tr>
        </thead>
        <tbody id="tabla">
            <!-- Se llena dinÃ¡micamente -->
        </tbody>
    </table>
</div>



<script>
let arbolMenus = [];

function cargarArbolMenus(cb) {
    fetch('/api/proce_arbol')
        .then(res => res.json())
        .then(data => {
            arbolMenus = data;
            if (cb) cb();
        });
}

function renderSelectoresNiveles(seleccionRuta = "") {
    const cont = document.getElementById('nivelesContainer');
    cont.innerHTML = '';

    function agregarSelect(nodos, nivel, rutaSeleccionada = "") {
        const select = document.createElement('select');
        select.className = 'form-control nivel-select mb-2';
        select.setAttribute('data-nivel', nivel);
        select.innerHTML = `<option value="" ${rutaSeleccionada === "" ? "selected" : ""}>Sin seleccionar</option>`;
        
        nodos.forEach(item => {
            const selected = (rutaSeleccionada === item.ruta_jerarquia) ? 'selected' : '';
            select.innerHTML += `<option value="${item.ruta_jerarquia}" ${selected}>${item.emoji} ${item.nombre}</option>`;
        });

        select.onchange = function () {
            // Eliminar selects inferiores
            let siguiente = this.nextElementSibling;
            while (siguiente) {
                siguiente.remove();
                siguiente = this.nextElementSibling;
            }

            if (this.value) {
                const seleccionado = buscarNodoPorRuta(arbolMenus, this.value);
                if (seleccionado && seleccionado.submenues && seleccionado.submenues.length > 0) {
                    agregarSelect(seleccionado.submenues, nivel + 1);
                }
            }
        };

        cont.appendChild(select);
    }

    if (seleccionRuta) {
        // Construir selects para cada nivel basado en ruta seleccionada
        const partes = seleccionRuta.split('.');
        let nodosActuales = arbolMenus;

        for (let i = 0; i < partes.length; i++) {
            const rutaParcial = partes.slice(0, i + 1).join('.');
            agregarSelect(nodosActuales, i, rutaParcial);

            const nodoSeleccionado = nodosActuales.find(n => n.ruta_jerarquia === rutaParcial);
            if (nodoSeleccionado && nodoSeleccionado.submenues && nodoSeleccionado.submenues.length > 0) {
                nodosActuales = nodoSeleccionado.submenues;
            } else {
                break;
            }
        }
    } else {
        agregarSelect(arbolMenus, 0);
    }
}

function getNextRuta(ruta) {
    const partes = ruta.split('.');
    if (partes.length === 0) return '';
    return partes.slice(0, partes.length + 1).join('.');
}

function buscarNodoPorRuta(arbol, ruta) {
    const partes = ruta.split('.');
    let actual = arbol;
    let nodoEncontrado = null;
    
    for (let i = 0; i < partes.length; i++) {
        const parteActual = partes.slice(0, i + 1).join('.');
        nodoEncontrado = actual.find(item => item.ruta_jerarquia === parteActual);
        if (!nodoEncontrado) return null;
        actual = nodoEncontrado.submenues || [];
    }
    return nodoEncontrado;
}



function obtenerRutaPadre() {
    const selects = document.querySelectorAll('.nivel-select');
    let ruta = '';
    selects.forEach(sel => {
        if (sel.value) ruta = sel.value;
    });
    return ruta;
}

function guardar() {
    const nombre = document.getElementById("nombre").value;
    const emoji = document.getElementById("emoji").value.trim();
    const ruta_menu = document.getElementById("ruta_menu").value.trim();
    const ruta_padre = obtenerRutaPadre();

    if (!nombre || !emoji) return alert("Complete todos los campos");

    fetch('/api/proce', {
        method: "POST",
        headers: { "Content-Type": "application/json" },
        body: JSON.stringify({ nombre, emoji, ruta: ruta_menu, ruta_padre })
    }).then(res => res.json())
        .then(res => {
            alert(res.msg);
            cargarTodo();
            cancelar();
        });
}

function editar() {
    const nombre = document.getElementById("nombre").value;
    const emoji = document.getElementById("emoji").value.trim();
    const ruta_menu = document.getElementById("ruta_menu").value.trim();
    const ruta = document.getElementById("ruta_original").value;

    if (!nombre || !emoji || !ruta) return alert("Complete todos los campos");

    fetch('/api/proce', {
        method: "PUT",
        headers: { "Content-Type": "application/json" },
        body: JSON.stringify({ nombre, emoji, ruta_menu, ruta })
    }).then(res => res.json())
        .then(res => {
            alert(res.msg);
            cargarTodo();
            cancelar();
        });
}

function eliminar(ruta) {
    if (!confirm(`Â¿EstÃ¡ seguro de eliminar este Ã­tem?`)) return;
    fetch('/api/proce', {
        method: "DELETE",
        headers: { "Content-Type": "application/json" },
        body: JSON.stringify({ ruta })
    }).then(res => res.json())
        .then(res => {
            alert(res.msg);
            cargarTodo();
            cancelar();
        });
}

function prepararEdicionDesdeDataset(btn) {
    const nombre = decodeURIComponent(btn.dataset.nombre);
    const emoji = decodeURIComponent(btn.dataset.emoji);
    const ruta_menu = decodeURIComponent(btn.dataset.ruta_menu);
    const ruta_jerarquia = btn.dataset.ruta;

    prepararEdicion(ruta_jerarquia, nombre, emoji, ruta_menu);
}

function prepararEdicion(ruta_jerarquia, nombre, emoji, ruta_menu) {
    document.getElementById("nombre").value = nombre;
    document.getElementById("emoji").value = emoji;
    document.getElementById("ruta_menu").value = ruta_menu || "";
    document.getElementById("ruta_original").value = ruta_jerarquia;
    document.querySelector(".btn-agregar").style.display = "none";
    document.querySelector(".btn-editar").style.display = "inline";
    document.querySelector(".btn-cancelar").style.display = "inline";

    const rutaPadre = ruta_jerarquia.split('.').slice(0, -1).join('.');
    renderSelectoresNiveles(rutaPadre);
}

function cancelar() {
    document.getElementById("nombre").value = "";
    document.getElementById("emoji").value = "";
    document.getElementById("ruta_menu").value = "";
    document.getElementById("ruta_original").value = "";
    document.querySelector(".btn-agregar").style.display = "inline";
    document.querySelector(".btn-editar").style.display = "none";
    document.querySelector(".btn-cancelar").style.display = "none";
    renderSelectoresNiveles();
}

function cargarTabla() {
    fetch('/api/proce_arbol')
        .then(res => res.json())
        .then(data => {
            const tabla = document.getElementById("tabla");
            tabla.innerHTML = "";
            function recorrer(menus, nivel = 0) {
                menus.forEach(menu => {
                    tabla.innerHTML += `
                    <tr>
                        <td>${menu.emoji}</td>
                        <td style="padding-left:${nivel * 30}px">${menu.nombre}</td>
                        <td>${menu.ruta || ''}</td>
                        <td>
                            <button class="btn btn-sm btn-outline-primary"
                                data-ruta="${menu.ruta_jerarquia}"
                                data-nombre="${encodeURIComponent(menu.nombre)}"
                                data-emoji="${encodeURIComponent(menu.emoji)}"
                                data-ruta_menu="${encodeURIComponent(menu.ruta || "")}"
                                onclick="prepararEdicionDesdeDataset(this)">Editar</button>
                            <button class="btn btn-sm btn-outline-danger"
                                onclick="eliminar('${menu.ruta_jerarquia}')">Eliminar</button>
                        </td>
                    </tr>
                `;
                    if (menu.submenues && menu.submenues.length > 0) {
                        recorrer(menu.submenues, nivel + 1);
                    }
                });
            }
            recorrer(data);
        });
}

function cargarTodo() {
    cargarArbolMenus(() => {
        renderSelectoresNiveles();
        cargarTabla();
    });
}

document.addEventListener("DOMContentLoaded", cargarTodo);
</script>


{% endblock %}

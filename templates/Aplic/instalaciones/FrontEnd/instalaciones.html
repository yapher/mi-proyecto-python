{% extends 'layout.html' %}
{% block content %}
<h3 class="mb-3">Instalaciones</h3>

<div id="tree-container" class="tree"></div>

<style>
.tree, .tree ul { list-style: none; margin: 0; padding: 0; }
.tree > ul { position: relative; display: flex; gap: 40px; }
.collapsed { display: none !important; }
.ul-flex { display: flex; gap: 40px; position: relative; }
.node { display: inline-flex; flex-direction: column; align-items: center; position: relative; cursor: pointer; user-select: none; padding: 4px 8px; }
.node img { width:48px; height:48px; border-radius:8px; box-shadow:0 1px 4px rgba(0,0,0,0.15); object-fit: contain; background:transparent !important; }
.node .label { margin-top:8px; font-size:0.95rem; font-weight:600; color:white; max-width:180px; text-align:center; white-space:normal; user-select:text; word-break:break-word; }
.toggle { margin-top:6px; padding:0; width:28px; height:28px; border-radius:50%; border:1.5px solid #0d6efd; background-color:white; color:#0d6efd; font-weight:700; font-size:20px; line-height:24px; display:flex; justify-content:center; align-items:center; cursor:pointer; user-select:none; transition: background-color 0.3s, color 0.3s; box-shadow: 0 1px 3px rgba(13,110,253,0.4); }
.toggle:hover, .toggle:focus { background-color:#0d6efd; color:white; outline:none; box-shadow:0 0 8px rgba(13,110,253,0.7); }
.children-container { margin-top: 30px; padding-left: 0; position:relative; }
</style>

<svg id="svg-lines" style="position:absolute; top:0; left:0; pointer-events:none; overflow: visible; z-index:0;"></svg>

{% include 'Aplic/instalaciones/FrontEnd/equipos.html' %}

<script>
document.addEventListener("DOMContentLoaded", async () => {
    const container = document.getElementById("tree-container");
    let ubicacionTecnicaData = null;

    async function cargarDatos() {
        const res = await fetch("/api/ubicacion_tecnica_json", {credentials:'same-origin'});
        ubicacionTecnicaData = await res.json();
    }

    function buscarUbicacionPorJerarquia(ruta_jerarquia, nodo) {
        if (nodo.ruta_jerarquia === ruta_jerarquia) return nodo;
        if (nodo.sububicaciones) {
            for (const hijo of nodo.sububicaciones) {
                const res = buscarUbicacionPorJerarquia(ruta_jerarquia, hijo);
                if (res) return res;
            }
        }
        return null;
    }

    function abrirModalUbicacion(rutaJerarquia) {
        let nodo = null;
        for (const raiz of ubicacionTecnicaData) {
            nodo = buscarUbicacionPorJerarquia(rutaJerarquia, raiz);
            if (nodo) break;
        }
        if (!nodo) {
            alert("Ubicación no encontrada");
            return;
        }
        const modalEl = document.getElementById('ubicacionModal');
        const modal = bootstrap.Modal.getOrCreateInstance(modalEl);

        document.getElementById('nombre').value = nodo.nombre || '';
        document.getElementById('emoji').value = nodo.emoji || '';
        document.getElementById('ruta').value = nodo.ruta || '';
        document.getElementById('ruta_jerarquia').value = nodo.ruta_jerarquia || '';
        document.getElementById('ruta_jerarquia_display').value = nodo.ruta_jerarquia || '';
        document.getElementById('modalImagen').src = nodo.imagen || "/static/factory.png";

        const cont = document.getElementById('sububicacionesContainer');
        cont.innerHTML = '';
        if (nodo.sububicaciones && nodo.sububicaciones.length) {
            nodo.sububicaciones.forEach(sub => {
                const div = document.createElement('div');
                div.className = 'text-white p-1 border-bottom border-secondary';
                div.textContent = `${sub.nombre} (${sub.ruta || 'sin ruta'})`;
                cont.appendChild(div);
            });
        }
        modal.show();
    }

    function crearNodo(nodo) {
        const li = document.createElement('li');
        const nodeDiv = document.createElement('div');
        nodeDiv.className = 'node';
        nodeDiv.tabIndex = 0;

        const img = document.createElement('img');
        img.src = nodo.imagen && nodo.imagen.trim()!=='' ? nodo.imagen : '/static/factory.png';
        img.alt = nodo.ruta || 'Sin ruta';

        const label = document.createElement('div');
        label.className = 'label';
        label.textContent = nodo.ruta && nodo.ruta.trim()!=='' ? nodo.ruta : 'Sin ruta';

        nodeDiv.appendChild(img);
        nodeDiv.appendChild(label);
        li.appendChild(nodeDiv);

        nodeDiv.addEventListener('click', e=>{
            e.stopPropagation();
            abrirModalUbicacion(nodo.ruta_jerarquia);
        });

        if (nodo.sububicaciones && nodo.sububicaciones.length > 0) {
            const toggle = document.createElement('button');
            toggle.className = 'toggle btn btn-outline-primary btn-sm';
            toggle.type = 'button';
            toggle.setAttribute('aria-expanded','false');
            toggle.title = 'Expandir';
            toggle.textContent = '+';
            nodeDiv.appendChild(toggle);

            const ulHijos = document.createElement('ul');
            ulHijos.className = 'children-container ul-flex collapsed';
            nodo.sububicaciones.forEach(sub => ulHijos.appendChild(crearNodo(sub)));
            li.appendChild(ulHijos);

            toggle.addEventListener('click', e=>{
                e.stopPropagation();
                const colapsado = ulHijos.classList.toggle('collapsed');
                toggle.textContent = colapsado ? '+' : '−';
                toggle.setAttribute('aria-expanded', String(!colapsado));
                setTimeout(dibujarLineas, 50);
            });

            nodeDiv.addEventListener('keydown', e=>{
                if(e.key==='Enter'||e.key===' '){
                    e.preventDefault();
                    toggle.click();
                }
            });
        }

        return li;
    }

    const root = document.createElement('ul');
    root.style.position = 'relative';
    root.classList.add('ul-flex');

    await cargarDatos();
    ubicacionTecnicaData.forEach(nodo => root.appendChild(crearNodo(nodo)));
    container.appendChild(root);

    const svg = document.getElementById('svg-lines');

    function dibujarLineas() {
        while(svg.firstChild) svg.removeChild(svg.firstChild);
        const containerRect = container.getBoundingClientRect();
        svg.style.width = containerRect.width + 'px';
        svg.style.height = containerRect.height + 'px';
        svg.style.top = containerRect.top + window.scrollY + 'px';
        svg.style.left = containerRect.left + window.scrollX + 'px';

        const parentNodes = container.querySelectorAll('li > .node');
        parentNodes.forEach(nodeDiv => {
            const li = nodeDiv.parentElement;
            const ulHijos = li.querySelector('ul.children-container:not(.collapsed)');
            if(!ulHijos) return;
            ulHijos.childNodes.forEach(childLi => {
                if(childLi.nodeType !== 1) return;
                const startImg = nodeDiv.querySelector('img').getBoundingClientRect();
                const endNode = childLi.querySelector('.node img');
                if(!endNode) return;
                const endImg = endNode.getBoundingClientRect();

                const x1 = startImg.left + startImg.width/2 - containerRect.left;
                const y1 = startImg.bottom - containerRect.top;
                const x2 = endImg.left + endImg.width/2 - containerRect.left;
                const y2 = endImg.top - containerRect.top;

                const group = document.createElementNS('http://www.w3.org/2000/svg','g');
                group.setAttribute('stroke','#0d6efd');
                group.setAttribute('fill','none');
                group.setAttribute('stroke-width','2');

                const path = document.createElementNS('http://www.w3.org/2000/svg','path');
                const d = `M ${x1} ${y1} L ${x1} ${(y1+y2)/2} L ${x2} ${(y1+y2)/2} L ${x2} ${y2}`;
                path.setAttribute('d', d);
                group.appendChild(path);
                svg.appendChild(group);
            });
        });
    }

    dibujarLineas();
    window.addEventListener('resize', dibujarLineas);
    window.addEventListener('scroll', dibujarLineas);

    // ---------- Manejo de formulario y botones ----------
    async function manejarFetch(url, options){
        try {
            const res = await fetch(url,{...options, credentials:'same-origin'});
            const text = await res.text();
            try {
                const json = JSON.parse(text);
                return {ok: res.ok, data: json};
            } catch {
                return {ok:false, data:{status:'error', msg:'Respuesta no es JSON: '+text}};
            }
        } catch(err){
            return {ok:false, data:{status:'error', msg: err.message}};
        }
    }

    document.getElementById('formUbicacion').addEventListener('submit', async e=>{
        e.preventDefault();
        const ruta = document.getElementById('ruta_jerarquia').value;
        const datos = {
            ruta_jerarquia: ruta,
            nombre: document.getElementById('nombre').value,
            emoji: document.getElementById('emoji').value,
            ruta: document.getElementById('ruta').value,
            imagen: document.getElementById('imagen').value
        };
        const {ok, data} = await manejarFetch('/api/editar_ubicacion',{
            method:'PUT',
            headers:{'Content-Type':'application/json'},
            body:JSON.stringify(datos)
        });
        if(ok && data.status==='ok') alert('Datos guardados correctamente'), location.reload();
        else alert('Error al guardar cambios: '+(data.msg||JSON.stringify(data)));
    });

    document.getElementById('btnBorrarUbicacion').addEventListener('click', async ()=>{
        const ruta = document.getElementById('ruta_jerarquia').value;
        if(!confirm('¿Seguro que quieres borrar esta ubicación?')) return;
        const {ok, data} = await manejarFetch('/api/borrar_ubicacion',{
            method:'DELETE',
            headers:{'Content-Type':'application/json'},
            body: JSON.stringify({ruta_jerarquia: ruta})
        });
        if(ok && data.status==='ok') alert('Ubicación borrada'), location.reload();
        else alert('Error al borrar ubicación: '+(data.msg||JSON.stringify(data)));
    });

    document.getElementById('btnAgregarHijo').addEventListener('click', () => {
        const cont = document.getElementById('sububicacionesContainer');
        const formDiv = document.createElement('div');
        formDiv.className = 'mb-3 mt-3 border p-2 bg-dark text-white rounded';

        formDiv.innerHTML = `
            <h6>Agregar sububicación</h6>
            <input type="text" id="nombreHijo" class="form-control mb-2" placeholder="Nombre" required>
            <input type="text" id="emojiHijo" class="form-control mb-2" placeholder="Emoji">
            <input type="text" id="rutaHijo" class="form-control mb-2" placeholder="Ruta">
            <button class="btn btn-success btn-sm" id="guardarHijoBtn">Guardar sububicación</button>
        `;
        cont.appendChild(formDiv);

        formDiv.querySelector('#guardarHijoBtn').addEventListener('click', async e => {
            e.preventDefault();
            const nuevoHijo = {
                nombre: formDiv.querySelector('#nombreHijo').value,
                emoji: formDiv.querySelector('#emojiHijo').value,
                ruta: formDiv.querySelector('#rutaHijo').value,
                ruta_jerarquia: '',
                sububicaciones: []
            };
            const rutaPadre = document.getElementById('ruta_jerarquia').value;
            const {ok, data} = await manejarFetch('/api/agregar_sububicacion',{
                method:'POST',
                headers:{'Content-Type':'application/json'},
                body: JSON.stringify({ruta_padre: rutaPadre, nuevo_hijo: nuevoHijo})
            });
            if(ok && data.status==='ok') alert('Sububicación agregada'), location.reload();
            else alert('Error al agregar sububicación: '+(data.msg||JSON.stringify(data)));
        });
    });

});
</script>
{% endblock %}